<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analisis Turunan Kecepatan WiFi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <style>
      :root {
        --primary: #6366f1;
        --secondary: #4f46e5;
        --accent: #10b981;
        --dark: #1f2937;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
      }
      .primary {
        color: var(--primary);
      }
      .bg-primary {
        background-color: var(--primary);
      }
      .bg-secondary {
        background-color: var(--secondary);
      }
      .hover\:bg-secondary:hover {
        background-color: var(--secondary);
      }
      .text-dark {
        color: var(--dark);
      }
      .bg-dark {
        background-color: var(--dark);
      }
      .text-accent {
        color: var(--accent);
      }
      .container {
        max-width: 1200px;
      }
      canvas#galaxyCanvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        pointer-events: none;
      }
      main {
        position: relative;
        z-index: 1;
      }
    </style>
  </head>
  <body>
    <canvas id="galaxyCanvas"></canvas>

    <main class="container mx-auto px-4 py-8">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-5xl font-bold text-white mb-4">
          Analisis Turunan Kecepatan WiFi
        </h1>
        <p class="text-xl text-gray-200 mb-8">
          Alat Pemantauan Performa Jaringan dengan Analisis Matematika Lanjutan
        </p>

        <!-- Navigation Buttons -->
        <div class="flex justify-center gap-4 flex-wrap">
          <button
            onclick="showSection('monitor')"
            class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-secondary transition-all duration-300 transform hover:scale-105"
          >
            <i class="fas fa-chart-line mr-2"></i>Monitoring
          </button>
          <button
            onclick="showSection('comparison')"
            class="px-6 py-3 bg-accent text-white rounded-lg hover:bg-green-600 transition-all duration-300 transform hover:scale-105"
          >
            <i class="fas fa-exchange-alt mr-2"></i>Perbandingan
          </button>
          <button
            onclick="showSection('theory')"
            class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all duration-300 transform hover:scale-105"
          >
            <i class="fas fa-book mr-2"></i>Teori
          </button>
        </div>
      </div>

      <!-- Monitor Section -->
      <section
        id="monitor"
        class="bg-white rounded-2xl shadow-2xl p-6 mb-8 transform transition-all duration-500"
      >
        <div class="text-center mb-8">
          <h2
            class="text-3xl font-bold text-dark mb-4 inline-flex items-center justify-center"
          >
            Pemantauan Kecepatan WiFi
            <button
              onclick="showGuide('monitor')"
              title="Panduan Monitoring"
              class="ml-3 text-lg text-gray-400 hover:text-gray-700 focus:outline-none"
            >
              <i class="fas fa-question-circle"></i>
            </button>
          </h2>
          <p class="text-gray-600 text-lg">
            Pantau dan analisis performa jaringan WiFi Anda secara real-time
          </p>
        </div>

        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div
            class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white transform transition-all duration-300 hover:scale-105 hover:shadow-xl"
          >
            <div class="flex items-center justify-between">
              <div>
                <p class="text-blue-100">Kecepatan Saat Ini</p>
                <h3 id="currentSpeed" class="text-3xl font-bold">0.00 MB/s</h3>
              </div>
              <i class="fas fa-wifi text-2xl"></i>
            </div>
          </div>

          <div
            class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white transform transition-all duration-300 hover:scale-105 hover:shadow-xl"
          >
            <div class="flex items-center justify-between">
              <div>
                <p class="text-green-100">Rata-rata Kecepatan</p>
                <h3 id="averageSpeed" class="text-3xl font-bold">0.00 MB/s</h3>
              </div>
              <i class="fas fa-chart-bar text-2xl"></i>
            </div>
          </div>

          <div
            class="bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl p-6 text-white transform transition-all duration-300 hover:scale-105 hover:shadow-xl"
          >
            <div class="flex items-center justify-between">
              <div>
                <p class="text-purple-100">Turunan</p>
                <h3 id="currentDerivative" class="text-3xl font-bold">0.00</h3>
              </div>
              <i class="fas fa-calculator text-2xl"></i>
            </div>
          </div>
        </div>

        <!-- Control Panel - Download from URL -->
        <div
          class="bg-gray-50 rounded-xl p-6 mb-8 border-2 border-dashed border-gray-300"
        >
          <h3 class="text-xl font-semibold text-dark mb-4">
            <i class="fas fa-download mr-2 text-primary"></i>Monitor Kecepatan
            Download
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >URL File untuk Download (YouTube, direktori file, dll)</label
              >
              <div class="flex space-x-2">
                <div class="relative flex-1">
                  <input
                    type="url"
                    id="downloadUrl"
                    placeholder="https://example.com/file.mp4"
                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg shadow-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                  />
                  <i
                    class="fas fa-link absolute top-2 right-2 text-gray-400 text-sm"
                  ></i>
                </div>
                <button
                  onclick="startDownloadMonitoring()"
                  id="startDownloadBtn"
                  class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all duration-300 transform hover:scale-105"
                >
                  <i class="fas fa-download mr-2"></i>Mulai
                </button>
              </div>
              <p class="text-xs text-gray-500 mt-2">
                ðŸ’¡ Catatan: Gunakan link file langsung atau test URL dengan CORS
                enabled
              </p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Status & Kontrol</label
              >
              <div class="flex space-x-2">
                <button
                  id="pauseDownloadBtn"
                  onclick="pauseDownloadMonitoring()"
                  class="flex-1 px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-all duration-300 transform hover:scale-105 opacity-50 cursor-not-allowed"
                  disabled
                >
                  <i class="fas fa-pause mr-2"></i>Pause
                </button>
                <button
                  onclick="clearData()"
                  class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all duration-300 transform hover:scale-105"
                >
                  <i class="fas fa-trash mr-2"></i>Bersihkan
                </button>
              </div>
              <div id="downloadStatus" class="mt-3 text-sm text-gray-600">
                <p id="downloadStatusText">Siap untuk download</p>
                <div
                  class="w-full bg-gray-200 rounded h-2 mt-2 overflow-hidden"
                >
                  <div
                    id="downloadProgressBar"
                    class="bg-primary h-2 rounded"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <div
            class="bg-white rounded-xl p-6 shadow-lg border border-gray-200 transform transition-all duration-300 hover:shadow-xl"
          >
            <h3 class="text-xl font-semibold text-dark mb-4">
              Kecepatan WiFi Seiring Waktu
            </h3>
            <div class="h-80">
              <canvas id="speedChart"></canvas>
            </div>
          </div>
          <div
            class="bg-white rounded-xl p-6 shadow-lg border border-gray-200 transform transition-all duration-300 hover:shadow-xl"
          >
            <h3 class="text-xl font-semibold text-dark mb-4">
              Turunan Kecepatan
            </h3>
            <div class="h-80">
              <canvas id="derivativeChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-xl p-6 shadow-lg border border-gray-200">
          <h3 class="text-xl font-semibold text-dark mb-4">
            Riwayat Data Kecepatan
          </h3>
          <div class="overflow-x-auto">
            <table class="w-full table-auto">
              <thead>
                <tr class="bg-gray-50">
                  <th class="px-4 py-2 text-left">Waktu</th>
                  <th class="px-4 py-2 text-left">Kecepatan (MB/s)</th>
                  <th class="px-4 py-2 text-left">Turunan</th>
                  <th class="px-4 py-2 text-left">Status</th>
                </tr>
              </thead>
              <tbody id="dataTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Comparison Section -->
      <section
        id="comparison"
        class="bg-white rounded-2xl shadow-2xl p-6 mb-8 hidden transform transition-all duration-500"
      >
        <div class="text-center mb-8">
          <h2
            class="text-3xl font-bold text-dark mb-4 inline-flex items-center justify-center"
          >
            Perbandingan Grafik WiFi
            <button
              onclick="showGuide('comparison')"
              title="Panduan Perbandingan"
              class="ml-3 text-lg text-gray-400 hover:text-gray-700 focus:outline-none"
            >
              <i class="fas fa-question-circle"></i>
            </button>
          </h2>
          <p class="text-gray-600 text-lg">
            Bandingkan performa real-time dua jaringan WiFi dengan memasukkan
            URL download untuk masing-masing dan merekam kecepatan selama proses
            unduhan
          </p>
        </div>

        <!-- WiFi Input Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div
            class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border-2 border-blue-300"
          >
            <h3 class="text-xl font-semibold text-dark mb-4 flex items-center">
              <i class="fas fa-wifi text-blue-500 mr-2"></i>WiFi Pertama
            </h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Nama WiFi</label
                >
                <input
                  type="text"
                  id="wifi1Name"
                  placeholder="Misal: WiFi Rumah"
                  class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >URL Download (untuk capture kecepatan)</label
                >
                <input
                  type="url"
                  id="wifi1Url"
                  placeholder="https://example.com/file1.bin"
                  class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
              <div class="flex space-x-2">
                <button
                  id="startWifi1Btn"
                  onclick="startWiFiComparisonDownload(1)"
                  class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-300"
                >
                  <i class="fas fa-play mr-2"></i>Mulai
                </button>
                <button
                  id="pauseWifi1Btn"
                  onclick="pauseWiFiComparisonDownload(1)"
                  class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-all duration-300 opacity-50 cursor-not-allowed"
                  disabled
                >
                  <i class="fas fa-pause mr-2"></i>Pause
                </button>
              </div>
            </div>
          </div>

          <div
            class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border-2 border-green-300"
          >
            <h3 class="text-xl font-semibold text-dark mb-4 flex items-center">
              <i class="fas fa-wifi text-green-500 mr-2"></i>WiFi Kedua
            </h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Nama WiFi</label
                >
                <input
                  type="text"
                  id="wifi2Name"
                  placeholder="Misal: WiFi Kantor"
                  class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >URL Download (untuk capture kecepatan)</label
                >
                <input
                  type="url"
                  id="wifi2Url"
                  placeholder="https://example.com/file2.bin"
                  class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                />
              </div>
              <div class="flex space-x-2">
                <button
                  id="startWifi2Btn"
                  onclick="startWiFiComparisonDownload(2)"
                  class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all duration-300"
                >
                  <i class="fas fa-play mr-2"></i>Mulai
                </button>
                <button
                  id="pauseWifi2Btn"
                  onclick="pauseWiFiComparisonDownload(2)"
                  class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-all duration-300 opacity-50 cursor-not-allowed"
                  disabled
                >
                  <i class="fas fa-pause mr-2"></i>Pause
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Data Display -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="bg-gray-50 rounded-xl p-6 border-2 border-blue-300">
            <h3 class="text-lg font-semibold text-dark mb-3">
              <i class="fas fa-database text-blue-500 mr-2"></i>Data WiFi 1
            </h3>
            <div id="wifi1DataDisplay" class="text-sm text-gray-700 space-y-1">
              <p>Belum ada data</p>
            </div>
          </div>

          <div class="bg-gray-50 rounded-xl p-6 border-2 border-green-300">
            <h3 class="text-lg font-semibold text-dark mb-3">
              <i class="fas fa-database text-green-500 mr-2"></i>Data WiFi 2
            </h3>
            <div id="wifi2DataDisplay" class="text-sm text-gray-700 space-y-1">
              <p>Belum ada data</p>
            </div>
          </div>
        </div>

        <!-- Chart Section -->
        <div
          class="bg-white rounded-xl p-6 shadow-lg border border-gray-200 mb-6"
        >
          <h3 class="text-xl font-semibold text-dark mb-4">
            <i class="fas fa-chart-line text-primary mr-2"></i>Grafik
            Perbandingan Kecepatan
          </h3>
          <div class="h-96">
            <canvas id="wifiComparisonChart"></canvas>
          </div>
        </div>

        <!-- Control Buttons -->
        <div class="flex gap-3 flex-wrap justify-center">
          <button
            onclick="resetComparison()"
            class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all duration-300 transform hover:scale-105"
          >
            <i class="fas fa-redo mr-2"></i>Reset Semua
          </button>
          <button
            onclick="clearWiFi1()"
            class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-300 transform hover:scale-105"
          >
            <i class="fas fa-trash mr-2"></i>Hapus WiFi 1
          </button>
          <button
            onclick="clearWiFi2()"
            class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all duration-300 transform hover:scale-105"
          >
            <i class="fas fa-trash mr-2"></i>Hapus WiFi 2
          </button>
        </div>
      </section>

      <!-- Theory Section -->
      <section
        id="theory"
        class="bg-white rounded-2xl shadow-2xl p-6 mb-8 hidden transform transition-all duration-500"
      >
        <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-dark mb-4">
            Teori Turunan Kecepatan WiFi
          </h2>
          <p class="text-gray-600 text-lg">
            Memahami matematika di balik analisis kecepatan
          </p>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div
            class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl p-6 border border-blue-200"
          >
            <h3 class="text-2xl font-bold text-dark mb-4 flex items-center">
              <i class="fas fa-calculator mr-3 text-primary"></i>Dasar
              Matematika
            </h3>
            <div class="space-y-4">
              <div
                class="relative bg-white p-4 rounded-lg shadow-lg border-2 border-gray-300"
              >
                <i
                  class="fas fa-calculator absolute top-2 right-2 text-primary text-lg"
                ></i>
                <h4 class="font-semibold text-dark mb-2">Definisi Turunan</h4>
                <p class="text-gray-700 mb-3">
                  Turunan kecepatan WiFi mewakili laju perubahan kecepatan
                  terhadap waktu:
                </p>
                <div class="bg-gray-100 p-3 rounded text-center font-mono">
                  f'(t) = lim<sub>hâ†’0</sub> [f(t+h) - f(t)] / h
                </div>
              </div>
              <div
                class="relative bg-white p-4 rounded-lg shadow-lg border-2 border-gray-300"
              >
                <i
                  class="fas fa-chart-line absolute top-2 right-2 text-primary text-lg"
                ></i>
                <h4 class="font-semibold text-dark mb-2">Pendekatan Diskrit</h4>
                <p class="text-gray-700 mb-3">
                  Dalam aplikasi praktis, kami menggunakan perbedaan diskrit:
                </p>
                <div class="bg-gray-100 p-3 rounded text-center font-mono">
                  Derivative â‰ˆ (Speed<sub>n</sub> - Speed<sub>n-1</sub>) / Î”t
                </div>
              </div>
            </div>
          </div>
          <div
            class="bg-gradient-to-br from-green-50 to-emerald-100 rounded-xl p-6 border border-green-200"
          >
            <h3 class="text-2xl font-bold text-dark mb-4 flex items-center">
              <i class="fas fa-network-wired mr-3 text-accent"></i
              >Implementation Details
            </h3>
            <div class="space-y-4">
              <div
                class="relative bg-white p-4 rounded-lg shadow-lg border-2 border-gray-300"
              >
                <i
                  class="fas fa-code absolute top-2 right-2 text-accent text-lg"
                ></i>
                <h4 class="font-semibold text-dark mb-2">Algoritma</h4>
                <pre
                  class="bg-gray-900 text-green-400 p-3 rounded text-sm overflow-x-auto"
                >
function calculateDerivative(speeds, timeInterval) {
    const derivatives = [];
    for (let i = 1; i < speeds.length; i++) {
        const derivative = (speeds[i] - speeds[i-1]) / timeInterval;
        derivatives.push(derivative);
    }
    return derivatives;
}</pre
                >
              </div>
              <div
                class="relative bg-white p-4 rounded-lg shadow-lg border-2 border-gray-300"
              >
                <i
                  class="fas fa-brain absolute top-2 right-2 text-accent text-lg"
                ></i>
                <h4 class="font-semibold text-dark mb-2">Interpretasi</h4>
                <ul class="text-gray-700 space-y-2">
                  <li class="flex items-center">
                    <i class="fas fa-arrow-up text-green-500 mr-2"></i
                    ><strong>Turunan Positif:</strong> Kecepatan meningkat
                  </li>
                  <li class="flex items-center">
                    <i class="fas fa-arrow-down text-red-500 mr-2"></i
                    ><strong>Turunan Negatif:</strong> Kecepatan menurun
                  </li>
                  <li class="flex items-center">
                    <i class="fas fa-minus text-blue-500 mr-2"></i
                    ><strong>Turunan Nol:</strong> Kecepatan konstan
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div
          class="mt-8 bg-gradient-to-br from-purple-50 to-pink-100 rounded-xl p-6 border border-purple-200"
        >
          <h3 class="text-2xl font-bold text-dark mb-6 flex items-center">
            <i class="fas fa-wifi mr-3 text-purple-500"></i>Real-world
            Applications
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div
              class="bg-white p-4 rounded-lg shadow-sm transform transition-all duration-300 hover:scale-105"
            >
              <div class="text-center">
                <i class="fas fa-network-wired text-3xl text-blue-500 mb-3"></i>
                <h4 class="font-semibold text-dark mb-2">Optimasi Jaringan</h4>
                <p class="text-gray-600 text-sm">
                  Identifikasi waktu penggunaan optimal dan bottleneck jaringan
                </p>
              </div>
            </div>
            <div
              class="bg-white p-4 rounded-lg shadow-sm transform transition-all duration-300 hover:scale-105"
            >
              <div class="text-center">
                <i
                  class="fas fa-exclamation-triangle text-3xl text-yellow-500 mb-3"
                ></i>
                <h4 class="font-semibold text-dark mb-2">Deteksi Anomali</h4>
                <p class="text-gray-600 text-sm">
                  Deteksi perubahan mendadak yang menunjukkan masalah jaringan
                </p>
              </div>
            </div>
            <div
              class="bg-white p-4 rounded-lg shadow-sm transform transition-all duration-300 hover:scale-105"
            >
              <div class="text-center">
                <i class="fas fa-chart-pie text-3xl text-green-500 mb-3"></i>
                <h4 class="font-semibold text-dark mb-2">Analisis Performa</h4>
                <p class="text-gray-600 text-sm">
                  Memahami pola perilaku jaringan dari waktu ke waktu
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-8 bg-white p-6 rounded-lg border border-gray-200">
          <h3 class="text-2xl font-bold text-dark mb-4 flex items-center">
            <i class="fas fa-lightbulb mr-3 text-primary"></i>Kenapa Web Ini
            Menarik dan Manfaatnya
          </h3>
          <p class="text-gray-700 mb-3">
            Aplikasi web ini bukan sekadar menampilkan angka â€” ia menggabungkan
            visualisasi, pengukuran waktu nyata, dan konsep turunan untuk
            membantu pengguna memahami bagaimana kecepatan WiFi berubah dari
            waktu ke waktu. Dengan melihat turunan (laju perubahan) dari
            kecepatan, pengguna dapat langsung mengenali momen ketika jaringan
            menjadi tidak stabil, menurun tajam, atau kembali stabil.
          </p>
          <p class="text-gray-700 mb-3">
            Manfaat praktisnya meliputi: identifikasi jam-jam sibuk (ketika laju
            menurun), deteksi gangguan sementara (lonjakan atau penurunan
            mendadak), dan pembandingan performa antar titik akses atau penyedia
            layanan. Pendekatan visual ini memudahkan teknisi, administrator
            jaringan, dan pengguna biasa untuk menemukan pola masalah tanpa
            harus memahami rumus matematika secara mendalam.
          </p>
          <p class="text-gray-700">
            Dari sisi materi turunan, web ini memperlihatkan bagaimana turunan
            diskrit (perbedaan bertingkat) menjadi alat diagnostik yang berguna:
            turunan positif menunjukkan pemulihan atau kenaikan kecepatan,
            turunan negatif menunjukkan penurunan, dan nilai mendekati nol
            menunjukkan kestabilan. Menggunakan grafik dan metrik sederhana,
            pengguna dapat mengambil keputusanâ€”misalnya mengganti saluran WiFi,
            memindahkan perangkat, atau menjadwalkan tugas berat pada waktu yang
            lebih stabilâ€”berdasarkan bukti visual dan ukuran matematis yang
            jelas.
          </p>
        </div>
      </section>
    </main>

    <!-- Guide Modal -->
    <div
      id="guideModal"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50"
    >
      <div class="bg-white rounded-lg w-11/12 max-w-2xl p-6 mx-4">
        <div class="flex items-start justify-between">
          <h3 id="guideTitle" class="text-xl font-bold text-dark">Panduan</h3>
          <button
            onclick="closeGuide()"
            aria-label="Tutup panduan"
            class="text-gray-500 hover:text-gray-800 ml-4 text-lg"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div
          id="guideContent"
          class="mt-4 text-gray-700 text-sm leading-relaxed"
        ></div>
        <div class="mt-6 text-right">
          <button
            onclick="closeGuide()"
            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all"
          >
            Tutup
          </button>
        </div>
      </div>
    </div>

    <footer class="bg-dark text-white py-8 mt-12 relative z-10">
      <div class="container mx-auto px-4">
        <div class="text-center">
          <h3 class="text-xl font-bold mb-4">
            Analisis Turunan Kecepatan WiFi
          </h3>
          <p class="text-gray-300 mb-4">
            Alat pemantauan performa jaringan canggih
          </p>
          <div class="flex justify-center space-x-4">
            <a
              href="#"
              class="text-gray-300 hover:text-white transition-colors duration-300"
              ><i class="fab fa-github text-2xl"></i
            ></a>
            <a
              href="#"
              class="text-gray-300 hover:text-white transition-colors duration-300"
              ><i class="fab fa-linkedin text-2xl"></i
            ></a>
            <a
              href="#"
              class="text-gray-300 hover:text-white transition-colors duration-300"
              ><i class="fab fa-twitter text-2xl"></i
            ></a>
          </div>
        </div>
        <div
          class="border-t border-gray-600 mt-6 pt-6 text-center text-gray-400"
        >
          <p>
            &copy; 2025 Analisis Kecepatan WiFi. Semua hak dilindungi
            undang-undang.
          </p>
        </div>
      </div>
    </footer>

    <script>
      // Data storage
      let speedData = [];
      let derivativeData = [];
      let timeData = [];
      let isMonitoring = false;
      let monitoringInterval;
      const timeInterval = 1;
      let speedChart, derivativeChart;

      // Download Monitoring Variables
      let downloadAbortController = null;
      let isDownloading = false;
      let downloadStartTime = 0;
      let lastMeasureTime = 0;
      let lastMeasureBytes = 0;
      let downloadIntervalId = null;
      // Backend URL for server-side YouTube handling
      const BACKEND_URL = "http://localhost:3000/api";

      // Comparison download variables (two separate downloads)
      let wifi1ComparisonData = [];
      let wifi2ComparisonData = [];
      let comparisonTimeLabels = [];
      let wifiComparisonChart = null;

      let wifi1AbortController = null;
      let wifi2AbortController = null;
      let wifi1Downloading = false;
      let wifi2Downloading = false;
      let wifi1TotalBytes = 0;
      let wifi2TotalBytes = 0;
      let wifi1LastBytes = 0;
      let wifi2LastBytes = 0;
      let wifi1LastTime = 0;
      let wifi2LastTime = 0;
      let wifi1StartTime = 0;
      let wifi2StartTime = 0;
      let wifi1IntervalId = null;
      let wifi2IntervalId = null;

      // Initialize charts
      function initializeCharts() {
        const speedCtx = document.getElementById("speedChart").getContext("2d");
        const derivativeCtx = document
          .getElementById("derivativeChart")
          .getContext("2d");

        speedChart = new Chart(speedCtx, {
          type: "line",
          data: {
            labels: timeData,
            datasets: [
              {
                label: "WiFi Speed (MB/s)",
                data: speedData,
                borderColor: "#3B82F6",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: "#3B82F6",
                pointBorderColor: "#ffffff",
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true },
              x: { title: { display: true, text: "Time (seconds)" } },
            },
            plugins: {
              legend: { display: true, position: "top" },
              tooltip: { mode: "index", intersect: false },
            },
            animation: { duration: 1000, easing: "easeOutQuart" },
          },
        });

        derivativeChart = new Chart(derivativeCtx, {
          type: "line",
          data: {
            labels: timeData.slice(1),
            datasets: [
              {
                label: "Speed Derivative",
                data: derivativeData,
                borderColor: "#10B981",
                backgroundColor: "rgba(16, 185, 129, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: "#10B981",
                pointBorderColor: "#ffffff",
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { title: { display: true, text: "Derivative (MB/sÂ²)" } },
            },
            plugins: {
              legend: { display: true, position: "top" },
              tooltip: { mode: "index", intersect: false },
            },
            animation: { duration: 1000, easing: "easeOutQuart" },
          },
        });
      }

      // Galaxy animation
      const galaxyCanvas = document.getElementById("galaxyCanvas");
      const ctx = galaxyCanvas.getContext("2d");
      let edgeStars = [];

      function EdgeStar(x, y, brightness, twinkleSpeed) {
        this.x = x;
        this.y = y;
        this.brightness = brightness;
        this.twinkleSpeed = twinkleSpeed;
        this.baseBrightness = brightness;
        this.size = 1.5 + Math.random();
      }

      EdgeStar.prototype.update = function (time) {
        this.brightness =
          this.baseBrightness + Math.sin(time * this.twinkleSpeed) * 0.4;
      };

      EdgeStar.prototype.draw = function () {
        ctx.save();
        ctx.globalAlpha = Math.max(0, this.brightness);
        ctx.fillStyle = "#ffffff";
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
      };

      function initGalaxy() {
        edgeStars = [];
        const edgeWidth = 100;
        const edgeStarCount = 150;

        for (let i = 0; i < edgeStarCount * 0.25; i++) {
          edgeStars.push(
            new EdgeStar(
              Math.random() * galaxyCanvas.width,
              Math.random() * edgeWidth,
              0.4 + Math.random() * 0.6,
              0.001 + Math.random() * 0.003
            )
          );
        }
        for (let i = 0; i < edgeStarCount * 0.25; i++) {
          edgeStars.push(
            new EdgeStar(
              Math.random() * galaxyCanvas.width,
              galaxyCanvas.height - Math.random() * edgeWidth,
              0.4 + Math.random() * 0.6,
              0.001 + Math.random() * 0.003
            )
          );
        }
        for (let i = 0; i < edgeStarCount * 0.25; i++) {
          edgeStars.push(
            new EdgeStar(
              Math.random() * edgeWidth,
              Math.random() * galaxyCanvas.height,
              0.4 + Math.random() * 0.6,
              0.001 + Math.random() * 0.003
            )
          );
        }
        for (let i = 0; i < edgeStarCount * 0.25; i++) {
          edgeStars.push(
            new EdgeStar(
              galaxyCanvas.width - Math.random() * edgeWidth,
              Math.random() * galaxyCanvas.height,
              0.4 + Math.random() * 0.6,
              0.001 + Math.random() * 0.003
            )
          );
        }
      }

      function animateGalaxy(timestamp) {
        ctx.clearRect(0, 0, galaxyCanvas.width, galaxyCanvas.height);
        const gradient = ctx.createLinearGradient(0, 0, 0, galaxyCanvas.height);
        gradient.addColorStop(0, "rgba(30, 40, 60, 0.1)");
        gradient.addColorStop(0.5, "rgba(10, 15, 30, 0.05)");
        gradient.addColorStop(1, "rgba(5, 10, 20, 0.1)");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, galaxyCanvas.width, galaxyCanvas.height);

        for (let star of edgeStars) {
          star.update(timestamp);
          star.draw();
        }
        requestAnimationFrame(animateGalaxy);
      }

      function resizeGalaxyCanvas() {
        galaxyCanvas.width = window.innerWidth;
        galaxyCanvas.height = window.innerHeight;
        initGalaxy();
      }

      window.addEventListener("resize", resizeGalaxyCanvas);
      window.addEventListener("load", resizeGalaxyCanvas);

      document.addEventListener("DOMContentLoaded", function () {
        initializeCharts();
        resizeGalaxyCanvas();
        requestAnimationFrame(animateGalaxy);

        setTimeout(() => {
          for (let i = 0; i < 5; i++) {
            const currentTime =
              timeData.length > 0
                ? timeData[timeData.length - 1] + timeInterval
                : 0;
            const speed = 10 + Math.random() * 5;
            timeData.push(currentTime);
            speedData.push(speed);
            if (speedData.length > 1) {
              derivativeData = calculateDerivative(speedData);
            }
          }
          updateCharts();
          updateDisplays();
          updateDataTable();
        }, 1000);

        document
          .getElementById("manualSpeed")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              addManualData();
            }
          });
      });

      function calculateDerivative(speeds) {
        const derivatives = [];
        for (let i = 1; i < speeds.length; i++) {
          const derivative = (speeds[i] - speeds[i - 1]) / timeInterval;
          derivatives.push(derivative);
        }
        return derivatives;
      }

      function updateDisplays() {
        const currentSpeed =
          speedData.length > 0 ? speedData[speedData.length - 1] : 0;
        const averageSpeed =
          speedData.length > 0
            ? speedData.reduce((a, b) => a + b, 0) / speedData.length
            : 0;
        const currentDerivative =
          derivativeData.length > 0
            ? derivativeData[derivativeData.length - 1]
            : 0;

        document.getElementById("currentSpeed").textContent =
          currentSpeed.toFixed(2) + " MB/s";
        document.getElementById("averageSpeed").textContent =
          averageSpeed.toFixed(2) + " MB/s";
        document.getElementById("currentDerivative").textContent =
          currentDerivative.toFixed(3);

        const derivativeElement = document.getElementById("currentDerivative");
        if (currentDerivative > 0.1) {
          derivativeElement.className = "text-3xl font-bold text-green-600";
        } else if (currentDerivative < -0.1) {
          derivativeElement.className = "text-3xl font-bold text-red-600";
        } else {
          derivativeElement.className = "text-3xl font-bold text-blue-600";
        }
      }

      function updateDataTable() {
        const tableBody = document.getElementById("dataTable");
        tableBody.innerHTML = "";
        for (let i = 0; i < speedData.length; i++) {
          const row = document.createElement("tr");
          row.className = i % 2 === 0 ? "bg-white" : "bg-gray-50";

          const timeCell = document.createElement("td");
          timeCell.className = "px-4 py-2 border-b border-gray-200";
          timeCell.textContent = timeData[i] + "s";

          const speedCell = document.createElement("td");
          speedCell.className =
            "px-4 py-2 border-b border-gray-200 font-semibold";
          speedCell.textContent = speedData[i].toFixed(2) + " MB/s";

          const derivativeCell = document.createElement("td");
          derivativeCell.className = "px-4 py-2 border-b border-gray-200";
          if (i > 0) {
            derivativeCell.textContent = derivativeData[i - 1].toFixed(3);
            if (derivativeData[i - 1] > 0.1) {
              derivativeCell.className += " text-green-600";
            } else if (derivativeData[i - 1] < -0.1) {
              derivativeCell.className += " text-red-600";
            } else {
              derivativeCell.className += " text-blue-600";
            }
          } else {
            derivativeCell.textContent = "N/A";
          }

          const statusCell = document.createElement("td");
          statusCell.className = "px-4 py-2 border-b border-gray-200";
          if (i === 0) {
            statusCell.textContent = "Initial";
            statusCell.className += " text-gray-500";
          } else {
            const derivative = derivativeData[i - 1];
            if (derivative > 0.1) {
              statusCell.innerHTML =
                '<i class="fas fa-arrow-up text-green-500 mr-1"></i> Increasing';
            } else if (derivative < -0.1) {
              statusCell.innerHTML =
                '<i class="fas fa-arrow-down text-red-500 mr-1"></i> Decreasing';
            } else {
              statusCell.innerHTML =
                '<i class="fas fa-minus text-blue-500 mr-1"></i> Stable';
            }
          }

          row.appendChild(timeCell);
          row.appendChild(speedCell);
          row.appendChild(derivativeCell);
          row.appendChild(statusCell);
          tableBody.appendChild(row);
        }
      }

      function addManualData() {
        const manualSpeedInput = document.getElementById("manualSpeed");
        const speed = parseFloat(manualSpeedInput.value);
        if (!isNaN(speed) && speed >= 0) {
          const currentTime =
            timeData.length > 0
              ? timeData[timeData.length - 1] + timeInterval
              : 0;
          timeData.push(currentTime);
          speedData.push(speed);
          if (speedData.length > 1) {
            derivativeData = calculateDerivative(speedData);
          }
          updateCharts();
          updateDisplays();
          updateDataTable();
          manualSpeedInput.value = "";
          manualSpeedInput.classList.add("ring-2", "ring-green-500");
          setTimeout(() => {
            manualSpeedInput.classList.remove("ring-2", "ring-green-500");
          }, 1000);
        } else {
          manualSpeedInput.classList.add("ring-2", "ring-red-500");
          setTimeout(() => {
            manualSpeedInput.classList.remove("ring-2", "ring-red-500");
          }, 1000);
        }
      }

      function simulateWiFiData() {
        const baseSpeed = 5 + Math.random() * 15;
        const noise = (Math.random() - 0.5) * 3;
        const trend = Math.sin(timeData.length * 0.1) * 2;
        return Math.max(0.1, baseSpeed + noise + trend);
      }

      function toggleMonitoring() {
        const button = document.getElementById("startMonitor");
        if (!isMonitoring) {
          isMonitoring = true;
          button.innerHTML = '<i class="fas fa-pause mr-2"></i>Stop Monitoring';
          button.className =
            "flex-1 px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-all duration-300 transform hover:scale-105";
          monitoringInterval = setInterval(() => {
            const currentTime =
              timeData.length > 0
                ? timeData[timeData.length - 1] + timeInterval
                : 0;
            const speed = simulateWiFiData();
            timeData.push(currentTime);
            speedData.push(speed);
            if (speedData.length > 1) {
              derivativeData = calculateDerivative(speedData);
            }
            updateCharts();
            updateDisplays();
            updateDataTable();
            if (timeData.length > 50) {
              timeData.shift();
              speedData.shift();
              if (derivativeData.length > 0) derivativeData.shift();
            }
          }, 1000);
        } else {
          isMonitoring = false;
          button.innerHTML = '<i class="fas fa-play mr-2"></i>Start Monitoring';
          button.className =
            "flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all duration-300 transform hover:scale-105";
          clearInterval(monitoringInterval);
        }
      }

      function updateCharts() {
        if (speedChart) {
          speedChart.data.labels = timeData;
          speedChart.data.datasets[0].data = speedData;
          speedChart.update("none");
        }
        if (derivativeChart) {
          derivativeChart.data.labels = timeData.slice(1);
          derivativeChart.data.datasets[0].data = derivativeData;
          derivativeChart.update("none");
        }
      }

      function clearData() {
        speedData = [];
        derivativeData = [];
        timeData = [];
        pauseDownloadMonitoring();
        updateCharts();
        updateDisplays();
        updateDataTable();
        document.body.classList.add("bg-red-100");
        setTimeout(() => {
          document.body.classList.remove("bg-red-100");
        }, 500);
      }

      // Download Monitoring Functions
      async function startDownloadMonitoring(
        urlParam = null,
        filenameParam = null
      ) {
        const url = urlParam
          ? urlParam
          : document.getElementById("downloadUrl").value.trim();
        if (!url) {
          alert("Silakan masukkan URL file untuk diunduh");
          return;
        }

        // Reset download state
        speedData = [];
        derivativeData = [];
        timeData = [];
        if (downloadAbortController) {
          try {
            downloadAbortController.abort();
          } catch (e) {}
        }
        downloadAbortController = new AbortController();
        isDownloading = true;
        downloadStartTime = Date.now();
        lastMeasureTime = downloadStartTime;
        lastMeasureBytes = 0;
        let totalBytes = 0;

        // Update UI
        document.getElementById("startDownloadBtn").disabled = true;
        document.getElementById("pauseDownloadBtn").disabled = false;
        document.getElementById("downloadStatusText").textContent =
          "Mengunduh...";
        document.getElementById("downloadProgressBar").style.width = "0%";

        try {
          const response = await fetch(url, {
            signal: downloadAbortController.signal,
            // mode: "no-cors" removed â€” server must allow CORS for full monitoring
            // If the server doesn't support CORS, response headers may be unavailable.
          });

          if (!response.ok && response.status !== 0) {
            throw new Error("Network response was not ok");
          }

          const reader = response.body.getReader();
          const contentLength = response.headers.get("content-length");
          const total = parseInt(contentLength, 10);

          // Measurement interval: update speed every 1 second
          downloadIntervalId = setInterval(() => {
            if (!isDownloading) return;
            const now = Date.now();
            const elapsedMs = now - lastMeasureTime;
            const elapsedSec = elapsedMs / 1000;
            const bytesDiff = totalBytes - lastMeasureBytes;
            const megabytesDiff = bytesDiff / (1024 * 1024);
            const mbps = megabytesDiff / elapsedSec;

            if (mbps > 0) {
              const currentTime = (now - downloadStartTime) / 1000;
              timeData.push(parseFloat(currentTime.toFixed(1)));
              speedData.push(Math.max(0, mbps));
              if (speedData.length > 1) {
                derivativeData = calculateDerivative(speedData);
              }
              updateCharts();
              updateDisplays();
              updateDataTable();
            }

            lastMeasureTime = now;
            lastMeasureBytes = totalBytes;
          }, 1000);

          // Read chunks
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            if (!isDownloading) {
              reader.cancel();
              break;
            }
            totalBytes += value.length;
            if (total) {
              const percentComplete = Math.round((totalBytes / total) * 100);
              document.getElementById("downloadProgressBar").style.width =
                percentComplete + "%";
              document.getElementById(
                "downloadStatusText"
              ).textContent = `Mengunduh: ${percentComplete}% - ${(
                totalBytes /
                (1024 * 1024)
              ).toFixed(2)} MB`;
            }
          }

          if (isDownloading) {
            isDownloading = false;
            clearInterval(downloadIntervalId);
            document.getElementById("downloadStatusText").textContent =
              "Download selesai!";
            document.getElementById("downloadProgressBar").style.width = "100%";
          }
        } catch (error) {
          if (error.name !== "AbortError") {
            console.error("Download error:", error);
            document.getElementById(
              "downloadStatusText"
            ).textContent = `Error: ${error.message}`;
          }
        } finally {
          isDownloading = false;
          clearInterval(downloadIntervalId);
          document.getElementById("startDownloadBtn").disabled = false;
          document.getElementById("pauseDownloadBtn").disabled = true;
        }
      }

      function pauseDownloadMonitoring() {
        if (isDownloading && downloadAbortController) {
          downloadAbortController.abort();
          isDownloading = false;
          clearInterval(downloadIntervalId);
          document.getElementById("downloadStatusText").textContent =
            "Download dihentikan";
          document.getElementById("startDownloadBtn").disabled = false;
          document.getElementById("pauseDownloadBtn").disabled = true;
        }
      }

      // Backend-assisted YouTube / Generic download helpers
      async function downloadYouTubeVideo() {
        const url = document.getElementById("downloadUrl").value.trim();
        const format = document.getElementById("formatSelect")
          ? document.getElementById("formatSelect").value
          : "mp4";

        if (!url.includes("youtube.com") && !url.includes("youtu.be")) {
          alert("Masukkan URL YouTube yang valid");
          return;
        }

        try {
          const infoResponse = await fetch(`${BACKEND_URL}/youtube/info`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url }),
          });

          if (!infoResponse.ok) throw new Error("Gagal mendapatkan info video");

          const videoInfo = await infoResponse.json();

          const quality = prompt(
            `Pilih kualitas untuk: ${videoInfo.title}\n` +
              `Format yang tersedia:\n` +
              videoInfo.formats
                .map((f) => `- ${f.quality} (${f.container})`)
                .join("\n") +
              `\nMasukkan itag atau ketik "highest" untuk kualitas tertinggi:`,
            "highest"
          );

          if (!quality) return;

          startYouTubeDownload(url, quality, format, videoInfo.title);
        } catch (error) {
          console.error("Error:", error);
          alert("Gagal memproses video YouTube");
        }
      }

      async function startYouTubeDownload(url, quality, format, title) {
        try {
          const downloadUrl = `${BACKEND_URL}/youtube/download?url=${encodeURIComponent(
            url
          )}&itag=${quality}&format=${format}`;
          // Reset data monitoring and start download (backend will proxy the video stream)
          clearData();
          startDownloadMonitoring(downloadUrl, `${title}.${format}`);
        } catch (error) {
          console.error("Download error:", error);
          alert("Gagal memulai download");
        }
      }

      async function downloadGenericFile() {
        const url = document.getElementById("downloadUrl").value.trim();
        if (!url) {
          alert("Masukkan URL file");
          return;
        }

        try {
          const downloadUrl = `${BACKEND_URL}/download?url=${encodeURIComponent(
            url
          )}`;
          clearData();
          startDownloadMonitoring(downloadUrl);
        } catch (error) {
          console.error("Download error:", error);
          alert("Gagal memulai download");
        }
      }

      // UI helpers: format selector insertion
      function addFormatSelector() {
        const downloadSection = document.querySelector(
          ".bg-gray-50.rounded-xl.p-6.mb-8"
        );
        if (!downloadSection) return;
        const formatSelector = `
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-file-video mr-2"></i>Format Download
                </label>
                <div class="flex space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="downloadType" value="youtube" checked 
                               class="form-radio text-primary" onchange="toggleDownloadType()">
                        <span class="ml-2">YouTube Video/MP3</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="downloadType" value="generic"
                               class="form-radio text-primary" onchange="toggleDownloadType()">
                        <span class="ml-2">File Umum</span>
                    </label>
                </div>
                
                <div id="formatOptions" class="mt-3">
                    <select id="formatSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="mp4">MP4 Video</option>
                        <option value="mp3">MP3 Audio</option>
                    </select>
                </div>
                
                <div class="mt-4 flex space-x-2">
                    <button onclick="startDownload()" 
                            class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                        <i class="fas fa-play mr-2"></i>Mulai Download
                    </button>
                    <button onclick="speedTest()" 
                            class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all">
                        <i class="fas fa-tachometer-alt mr-2"></i>Speed Test
                    </button>
                </div>
            </div>
        `;
        downloadSection.insertAdjacentHTML("beforeend", formatSelector);
      }

      function toggleDownloadType() {
        const downloadType = document.querySelector(
          'input[name="downloadType"]:checked'
        ).value;
        const formatOptions = document.getElementById("formatOptions");
        if (!formatOptions) return;
        if (downloadType === "youtube") {
          formatOptions.innerHTML = `
                <select id="formatSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="mp4">MP4 Video</option>
                    <option value="mp3">MP3 Audio</option>
                </select>
            `;
        } else {
          formatOptions.innerHTML = `
                <input type="text" id="customFilename" 
                       placeholder="Nama file (opsional)" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            `;
        }
      }

      function startDownload() {
        const downloadType = document.querySelector(
          'input[name="downloadType"]:checked'
        ).value;
        if (downloadType === "youtube") {
          downloadYouTubeVideo();
        } else {
          downloadGenericFile();
        }
      }

      async function speedTest() {
        try {
          clearData();
          const response = await fetch(`${BACKEND_URL}/speedtest`);
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const text = decoder.decode(value);
            const lines = text.trim().split("\n");
            lines.forEach((line) => {
              if (line) {
                const data = JSON.parse(line);
                const currentTime = data.elapsed;
                const currentSpeed = data.speed;
                timeData.push(parseFloat(currentTime.toFixed(1)));
                speedData.push(currentSpeed);
                if (speedData.length > 1)
                  derivativeData = calculateDerivative(speedData);
                updateCharts();
                updateDisplays();
                updateDataTable();
                document.getElementById(
                  "downloadStatusText"
                ).textContent = `Speed Test: ${data.percent.toFixed(
                  1
                )}% selesai`;
                document.getElementById(
                  "downloadSpeedText"
                ).textContent = `${currentSpeed.toFixed(2)} MB/s`;
                document.getElementById(
                  "downloadProgressBar"
                ).style.width = `${data.percent}%`;
              }
            });
          }
          document.getElementById("downloadStatusText").textContent =
            "Speed test selesai!";
        } catch (error) {
          console.error("Speed test error:", error);
          alert("Gagal melakukan speed test");
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        try {
          addFormatSelector();
        } catch (e) {}
      });

      function showSection(sectionId) {
        document
          .getElementById("monitor")
          .classList.toggle("hidden", sectionId !== "monitor");
        document
          .getElementById("comparison")
          .classList.toggle("hidden", sectionId !== "comparison");
        document
          .getElementById("theory")
          .classList.toggle("hidden", sectionId !== "theory");
        const activeSection = document.getElementById(sectionId);
        activeSection.classList.add("scale-105");
        setTimeout(() => {
          activeSection.classList.remove("scale-105");
        }, 300);
      }

      // Guide modal functions
      function showGuide(type) {
        const modal = document.getElementById("guideModal");
        const title = document.getElementById("guideTitle");
        const content = document.getElementById("guideContent");
        if (type === "monitor") {
          title.textContent = "Panduan Monitoring";
          content.innerHTML = `
            <ol class="list-decimal pl-5">
              <li>Masukkan URL file yang akan diunduh pada kotak <strong>URL File untuk Download</strong>. Untuk YouTube, gunakan tombol <em>Mulai Download</em> dengan backend proxy aktif.</li>
              <li>Tekan tombol <strong>Mulai</strong> untuk memulai capture. Aplikasi akan membaca stream dan merekam MB/s setiap 1 detik.</li>
              <li>Selama proses, grafik Kecepatan dan Turunan akan ter-update secara real-time. Lihat juga kartu <em>Kecepatan Saat Ini</em> dan <em>Rata-rata</em>.</li>
              <li>Gunakan <strong>Pause</strong> untuk menghentikan capture sementara, atau <strong>Bersihkan</strong> untuk mereset semua data.</li>
            </ol>
          `;
        } else if (type === "comparison") {
          title.textContent = "Panduan Perbandingan";
          content.innerHTML = `
            <ol class="list-decimal pl-5">
              <li>Untuk masing-masing WiFi, masukkan <strong>Nama WiFi</strong> (opsional) dan <strong>URL Download</strong> yang ingin Anda gunakan untuk pengukuran.</li>
              <li>Tekan <strong>Mulai</strong> pada WiFi 1 dan/atau WiFi 2 untuk memulai capture paralel. Aplikasi akan mengukur MB/s terukur setiap 1 detik untuk setiap sumber.</li>
              <li>Data akan tampil pada panel Data WiFi 1 / WiFi 2 dan pada grafik Perbandingan. Label sumbu waktu berupa "Detik 1, Detik 2, ..." sesuai sampel yang diambil.</li>
              <li>Gunakan tombol <strong>Pause</strong> pada masing-masing WiFi untuk menghentikan capture tanpa menghapus data. Gunakan <strong>Reset Semua</strong> untuk menghentikan dan menghapus semua data.</li>
              <li>Jika Anda ingin membandingkan YouTube, gunakan URL proxy backend (/api/youtube/download) atau gunakan tombol <em>Mulai Download</em> di bagian Monitoring untuk mendapatkan URL proxy lalu tempel di sini.</li>
            </ol>
          `;
        } else {
          title.textContent = "Panduan";
          content.textContent = "Panduan tidak tersedia.";
        }
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        // focus trap simple
        setTimeout(() => modal.querySelector("button").focus(), 100);
      }

      function closeGuide() {
        const modal = document.getElementById("guideModal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }

      // Close modal on ESC
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          const modal = document.getElementById("guideModal");
          if (modal && !modal.classList.contains("hidden")) {
            closeGuide();
          }
        }
      });

      // WiFi Comparison Functions
      // WiFi Comparison Functions - start/pause downloads for WiFi1 and WiFi2
      async function startWiFiComparisonDownload(n) {
        const urlEl = document.getElementById(
          n === 1 ? "wifi1Url" : "wifi2Url"
        );
        const url = urlEl ? urlEl.value.trim() : "";
        if (!url) {
          alert("Silakan masukkan URL file untuk WiFi " + n);
          return;
        }

        // choose variables by index
        const isFirst = n === 1;
        if (isFirst) {
          if (wifi1AbortController)
            try {
              wifi1AbortController.abort();
            } catch (e) {}
          wifi1AbortController = new AbortController();
          wifi1Downloading = true;
          wifi1TotalBytes = 0;
          wifi1LastBytes = 0;
          wifi1StartTime = Date.now();
          wifi1LastTime = wifi1StartTime;
          document.getElementById("startWifi1Btn").disabled = true;
          document.getElementById("pauseWifi1Btn").disabled = false;
        } else {
          if (wifi2AbortController)
            try {
              wifi2AbortController.abort();
            } catch (e) {}
          wifi2AbortController = new AbortController();
          wifi2Downloading = true;
          wifi2TotalBytes = 0;
          wifi2LastBytes = 0;
          wifi2StartTime = Date.now();
          wifi2LastTime = wifi2StartTime;
          document.getElementById("startWifi2Btn").disabled = true;
          document.getElementById("pauseWifi2Btn").disabled = false;
        }

        try {
          const response = await fetch(url, {
            signal: isFirst
              ? wifi1AbortController.signal
              : wifi2AbortController.signal,
          });

          if (!response.ok && response.status !== 0) {
            throw new Error("Network response was not ok");
          }

          const reader = response.body.getReader();
          const contentLength = response.headers.get("content-length");
          const total = contentLength ? parseInt(contentLength, 10) : null;

          // set interval to sample every 1 second
          const intervalId = setInterval(() => {
            if (isFirst && !wifi1Downloading) return;
            if (!isFirst && !wifi2Downloading) return;

            const now = Date.now();
            if (isFirst) {
              const elapsedMs = now - wifi1LastTime || 1;
              const elapsedSec = elapsedMs / 1000;
              const bytesDiff = wifi1TotalBytes - wifi1LastBytes;
              const megabytesDiff = bytesDiff / (1024 * 1024);
              const mbps = megabytesDiff / elapsedSec;
              if (mbps >= 0) {
                wifi1ComparisonData.push(Math.max(0, mbps));
              }
              wifi1LastTime = now;
              wifi1LastBytes = wifi1TotalBytes;
            } else {
              const elapsedMs = now - wifi2LastTime || 1;
              const elapsedSec = elapsedMs / 1000;
              const bytesDiff = wifi2TotalBytes - wifi2LastBytes;
              const megabytesDiff = bytesDiff / (1024 * 1024);
              const mbps = megabytesDiff / elapsedSec;
              if (mbps >= 0) {
                wifi2ComparisonData.push(Math.max(0, mbps));
              }
              wifi2LastTime = now;
              wifi2LastBytes = wifi2TotalBytes;
            }

            // update labels to the max length
            comparisonTimeLabels = [];
            for (
              let i = 1;
              i <=
              Math.max(wifi1ComparisonData.length, wifi2ComparisonData.length);
              i++
            ) {
              comparisonTimeLabels.push("Detik " + i);
            }

            updateWiFi1Display();
            updateWiFi2Display();
            updateComparisonChartDisplay();
          }, 1000);

          if (isFirst) wifi1IntervalId = intervalId;
          else wifi2IntervalId = intervalId;

          // read stream
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            if (isFirst && !wifi1Downloading) {
              reader.cancel();
              break;
            }
            if (!isFirst && !wifi2Downloading) {
              reader.cancel();
              break;
            }
            if (isFirst) {
              wifi1TotalBytes += value.length;
              if (total) {
                const percent = Math.round((wifi1TotalBytes / total) * 100);
                // update small UI inside comparison card if needed
              }
            } else {
              wifi2TotalBytes += value.length;
              if (total) {
                const percent = Math.round((wifi2TotalBytes / total) * 100);
              }
            }
          }

          // finished
          if (isFirst) {
            wifi1Downloading = false;
            clearInterval(wifi1IntervalId);
            document.getElementById("startWifi1Btn").disabled = false;
            document.getElementById("pauseWifi1Btn").disabled = true;
          } else {
            wifi2Downloading = false;
            clearInterval(wifi2IntervalId);
            document.getElementById("startWifi2Btn").disabled = false;
            document.getElementById("pauseWifi2Btn").disabled = true;
          }
        } catch (error) {
          if (error.name !== "AbortError") {
            console.error("Comparison download error:", error);
            alert("Error download WiFi " + n + ": " + error.message);
          }
        } finally {
          if (isFirst) {
            wifi1Downloading = false;
            clearInterval(wifi1IntervalId);
            document.getElementById("startWifi1Btn").disabled = false;
            document.getElementById("pauseWifi1Btn").disabled = true;
          } else {
            wifi2Downloading = false;
            clearInterval(wifi2IntervalId);
            document.getElementById("startWifi2Btn").disabled = false;
            document.getElementById("pauseWifi2Btn").disabled = true;
          }
        }
      }

      function pauseWiFiComparisonDownload(n) {
        if (n === 1) {
          if (wifi1AbortController) {
            try {
              wifi1AbortController.abort();
            } catch (e) {}
          }
          wifi1Downloading = false;
          clearInterval(wifi1IntervalId);
          document.getElementById("startWifi1Btn").disabled = false;
          document.getElementById("pauseWifi1Btn").disabled = true;
        } else {
          if (wifi2AbortController) {
            try {
              wifi2AbortController.abort();
            } catch (e) {}
          }
          wifi2Downloading = false;
          clearInterval(wifi2IntervalId);
          document.getElementById("startWifi2Btn").disabled = false;
          document.getElementById("pauseWifi2Btn").disabled = true;
        }
      }

      function updateWiFi1Display() {
        const display = document.getElementById("wifi1DataDisplay");
        if (wifi1ComparisonData.length === 0) {
          display.innerHTML = "<p>Belum ada data</p>";
        } else {
          const html = wifi1ComparisonData
            .map(
              (val, idx) =>
                `<p><span class="font-semibold">Detik ${
                  idx + 1
                }:</span> ${val.toFixed(2)} MB/s</p>`
            )
            .join("");
          display.innerHTML = html;
        }
      }

      function updateWiFi2Display() {
        const display = document.getElementById("wifi2DataDisplay");
        if (wifi2ComparisonData.length === 0) {
          display.innerHTML = "<p>Belum ada data</p>";
        } else {
          const html = wifi2ComparisonData
            .map(
              (val, idx) =>
                `<p><span class="font-semibold">Detik ${
                  idx + 1
                }:</span> ${val.toFixed(2)} MB/s</p>`
            )
            .join("");
          display.innerHTML = html;
        }
      }

      function updateComparisonChartDisplay() {
        if (
          wifi1ComparisonData.length === 0 &&
          wifi2ComparisonData.length === 0
        )
          return;

        const chartContainer = document.getElementById("wifiComparisonChart");
        if (wifiComparisonChart) wifiComparisonChart.destroy();

        const wifi1Name =
          document.getElementById("wifi1Name").value || "WiFi 1";
        const wifi2Name =
          document.getElementById("wifi2Name").value || "WiFi 2";

        const datasets = [];
        if (wifi1ComparisonData.length > 0) {
          datasets.push({
            label: wifi1Name,
            data: wifi1ComparisonData,
            borderColor: "#3B82F6",
            backgroundColor: "rgba(59, 130, 246, 0.1)",
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: "#3B82F6",
            pointBorderColor: "#ffffff",
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7,
          });
        }
        if (wifi2ComparisonData.length > 0) {
          datasets.push({
            label: wifi2Name,
            data: wifi2ComparisonData,
            borderColor: "#10B981",
            backgroundColor: "rgba(16, 185, 129, 0.1)",
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: "#10B981",
            pointBorderColor: "#ffffff",
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7,
          });
        }

        wifiComparisonChart = new Chart(chartContainer, {
          type: "line",
          data: {
            labels: comparisonTimeLabels,
            datasets: datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "Kecepatan (MB/s)" },
              },
            },
            plugins: {
              legend: { display: true, position: "top" },
              tooltip: { mode: "index", intersect: false },
            },
            animation: { duration: 500, easing: "easeOutQuart" },
          },
        });
      }

      function resetComparison() {
        // abort any running comparison downloads
        try {
          if (wifi1AbortController) wifi1AbortController.abort();
        } catch (e) {}
        try {
          if (wifi2AbortController) wifi2AbortController.abort();
        } catch (e) {}
        wifi1ComparisonData = [];
        wifi2ComparisonData = [];
        comparisonTimeLabels = [];
        document.getElementById("wifi1Url").value = "";
        document.getElementById("wifi2Url").value = "";
        document.getElementById("wifi1Name").value = "";
        document.getElementById("wifi2Name").value = "";
        updateWiFi1Display();
        updateWiFi2Display();
        if (wifiComparisonChart) {
          wifiComparisonChart.destroy();
          wifiComparisonChart = null;
        }
      }

      function clearWiFi1() {
        try {
          if (wifi1AbortController) wifi1AbortController.abort();
        } catch (e) {}
        wifi1ComparisonData = [];
        comparisonTimeLabels = [];
        for (
          let i = 1;
          i <= Math.max(wifi1ComparisonData.length, wifi2ComparisonData.length);
          i++
        ) {
          comparisonTimeLabels.push("Detik " + i);
        }
        document.getElementById("wifi1Url").value = "";
        updateWiFi1Display();
        updateComparisonChartDisplay();
      }

      function clearWiFi2() {
        try {
          if (wifi2AbortController) wifi2AbortController.abort();
        } catch (e) {}
        wifi2ComparisonData = [];
        comparisonTimeLabels = [];
        for (
          let i = 1;
          i <= Math.max(wifi1ComparisonData.length, wifi2ComparisonData.length);
          i++
        ) {
          comparisonTimeLabels.push("Detik " + i);
        }
        document.getElementById("wifi2Url").value = "";
        updateWiFi2Display();
        updateComparisonChartDisplay();
      }
    </script>
  </body>
</html>
